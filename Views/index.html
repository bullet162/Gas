<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Column Analyzer</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:#f8fafc;color:#1e293b;line-height:1.5}.container{max-width:800px;margin:0 auto;padding:1rem}.header{padding:1.5rem 0;border-bottom:1px solid #e2e8f0;margin-bottom:2rem}.header h1{font-size:1.8rem;font-weight:600;color:#0f172a}.card{background:#fff;border-radius:0.5rem;box-shadow:0 1px 3px rgba(0,0,0,0.1);padding:1.5rem;margin-bottom:1.5rem}.card h2{font-size:1.25rem;font-weight:600;margin-bottom:1rem;color:#0f172a}.form-group{margin-bottom:1rem}.form-group label{display:block;font-weight:500;margin-bottom:0.5rem}.form-group input{width:100%;padding:0.5rem;border:1px solid #cbd5e1;border-radius:0.25rem;font-size:1rem}.btn{background:#3b82f6;color:white;border:none;padding:0.5rem 1rem;border-radius:0.25rem;cursor:pointer;font-size:1rem;font-weight:500;transition:background 0.2s}.btn:hover{background:#2563eb}.btn:disabled{background:#93c5fd;cursor:not-allowed}.results{margin-top:1.5rem}.results h3{font-size:1.1rem;font-weight:600;margin-bottom:0.5rem}.line-graph{height:20px;background:#e2e8f0;border-radius:10px;margin:0.5rem 0;overflow:hidden}.line-value{height:100%;background:#3b82f6;border-radius:10px}.error{color:#ef4444;margin-top:0.5rem}.hidden{display:none}.flex{display:flex;gap:0.5rem}.mt-2{margin-top:1rem}
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>CSV Column Analyzer</h1>
        </header>
        
        <div class="card">
            <h2>Upload CSV File</h2>
            <div class="form-group">
                <label for="csvFile">Select CSV File</label>
                <input type="file" id="csvFile" accept=".csv">
            </div>
            <button id="uploadBtn" class="btn">Upload and Analyze</button>
            <div id="uploadError" class="error hidden"></div>
        </div>
        
        <div id="columnSection" class="card hidden">
            <h2>Column Information</h2>
            <div id="columnList"></div>
            
            <div class="form-group mt-2">
                <label for="columnSelect">Select Column to Analyze</label>
                <div class="flex">
                    <select id="columnSelect" class="form-control"></select>
                    <button id="analyzeBtn" class="btn">Analyze</button>
                </div>
            </div>
        </div>
        
        <div id="resultsSection" class="card hidden">
            <h2>Analysis Results</h2>
            <div id="resultsContent"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const csvFileInput = document.getElementById('csvFile');
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadError = document.getElementById('uploadError');
            const columnSection = document.getElementById('columnSection');
            const columnList = document.getElementById('columnList');
            const columnSelect = document.getElementById('columnSelect');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const resultsSection = document.getElementById('resultsSection');
            const resultsContent = document.getElementById('resultsContent');
            
            let currentFile = null;
            
            uploadBtn.addEventListener('click', handleUpload);
            analyzeBtn.addEventListener('click', handleAnalysis);
            
            function handleUpload() {
                const file = csvFileInput.files[0];
                if (!file) {
                    showError(uploadError, 'Please select a CSV file');
                    return;
                }
                
                currentFile = file;
                uploadError.classList.add('hidden');
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'Uploading...';
                
                const formData = new FormData();
                formData.append('file', file);
                
                fetch('http://192.168.1.34:5297/api/upload/csvColumnNames', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to upload file');
                    }
                    return response.json();
                })
                .then(columnNames => {
                    displayColumnNames(columnNames);
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'Upload and Analyze';
                })
                .catch(error => {
                    showError(uploadError, error.message);
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'Upload and Analyze';
                });
            }
            
            function displayColumnNames(columnNames) {
                columnList.innerHTML = <p><strong>Detected Columns:</strong> ${columnNames.join(', ')}</p>;
                
                columnSelect.innerHTML = '';
                columnNames.forEach(column => {
                    const option = document.createElement('option');
                    option.value = column;
                    option.textContent = column;
                    columnSelect.appendChild(option);
                });
                
                columnSection.classList.remove('hidden');
                resultsSection.classList.add('hidden');
            }
            
            function handleAnalysis() {
                const columnName = columnSelect.value;
                if (!columnName || !currentFile) {
                    return;
                }
                
                analyzeBtn.disabled = true;
                analyzeBtn.textContent = 'Analyzing...';
                
                const formData = new FormData();
                formData.append('file', currentFile);
                formData.append('columnName', columnName);
                
                fetch('http://192.168.1.34:5297/api/upload/csvActualValues', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to analyze column');
                    }
                    return response.json();
                })
                .then(result => {
                    displayResults(result, columnName);
                    analyzeBtn.disabled = false;
                    analyzeBtn.textContent = 'Analyze';
                })
                .catch(error => {
                    resultsContent.innerHTML = <p class="error">Error: ${error.message}</p>;
                    resultsSection.classList.remove('hidden');
                    analyzeBtn.disabled = false;
                    analyzeBtn.textContent = 'Analyze';
                });
            }
            
            function displayResults(result, columnName) {
                const maxValue = Math.max(...result.actualValues.map(item => item.count));
                
                resultsContent.innerHTML = `
                    <div class="results">
                        <h3>Analysis for: ${result.columnName}</h3>
                        <p><strong>Total Count:</strong> ${result.totalCount}</p>
                        <p><strong>Date of Entry:</strong> ${new Date(result.dateOfEntry).toLocaleDateString()}</p>
                        
                        <h3 class="mt-2">Value Distribution</h3>
                        ${result.actualValues.map(item => `
                            <div>
                                <p>${item.value}: ${item.count} (${((item.count / result.totalCount) * 100).toFixed(1)}%)</p>
                                <div class="line-graph">
                                    <div class="line-value" style="width: ${(item.count / maxValue) * 100}%"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                resultsSection.classList.remove('hidden');
            }
            
            function showError(element, message) {
                element.textContent = message;
                element.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>